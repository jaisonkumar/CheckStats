<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 900px;
            margin: auto;
            padding: 20px;
        }

        h1, h3 {
            text-align: center;
            margin-bottom: 20px;
        }

        .stats-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 20px;
        }

        .chart-container {
            margin-top: 30px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Player Analysis</h1>
        <div id="playerStats" class="stats-card"></div>

        <!-- Graph Containers -->
        <div class="chart-container">
            <h3>Time Controls Distribution</h3>
            <canvas id="timeControlChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Games Played Per Year</h3>
            <canvas id="gamesPerYearChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Win/Loss/Draw Percentages</h3>
            <canvas id="winLossChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Color Performance (White vs Black)</h3>
            <canvas id="colorPerformanceChart"></canvas>
        </div>
    </div>

    <script>
        // Extract the username from the query parameters
        const params = new URLSearchParams(window.location.search);
        const username = params.get('username');

        if (!username) {
            alert("No username provided. Redirecting to the homepage.");
            window.location.href = "/";
        } else {
            fetch(`https://lichess.org/api/user/${username}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("User not found.");
                    }
                    return response.json();
                })
                .then(data => {
                    fetch(`https://lichess.org/api/games/user/${username}?max=200&opening=false`) // Fetch a limited number of games
                        .then(gamesResponse => gamesResponse.text())
                        .then(gamesData => {
                            const games = parseGames(gamesData);
                            displayAnalysis(data, games);
                        });
                })
                .catch(error => {
                    alert(error.message);
                    window.location.href = "/";
                });
        }

        function parseGames(gamesData) {
            const lines = gamesData.split("\n");
            const games = [];

            for (let i = 0; i < lines.length; i++) {
                if (lines[i].startsWith("[Event")) {
                    const timeControl = lines[i + 1].match(/"([^"]+)"/)[1]; // Extract Time Control
                    const date = lines[i + 4].match(/"([^"]+)"/)[1]; // Extract Date
                    const result = lines[i + 6].match(/"([^"]+)"/)[1]; // Extract Result
                    const color = lines[i + 7].includes("White") ? "White" : "Black";
                    games.push({ timeControl, date, result, color });
                }
            }
            return games;
        }

        function displayAnalysis(data, games) {
            const statsDiv = document.getElementById('playerStats');
            statsDiv.innerHTML = ` 
                <h3>${data.username}</h3>
                <p><strong>Total Games:</strong> ${data.count.all}</p>
                <p><strong>Wins:</strong> ${data.count.win || 0}</p>
                <p><strong>Losses:</strong> ${data.count.loss || 0}</p>
                <p><strong>Draws:</strong> ${data.count.draw || 0}</p>
                <p><strong>Time Controls:</strong> Bullet: ${data.perfs.bullet.games || 0}, Blitz: ${data.perfs.blitz.games || 0}, 
                Rapid: ${data.perfs.rapid.games || 0}, Classical: ${data.perfs.classical.games || 0}</p>
            `;

            const timeControls = {
                Bullet: data.perfs.bullet.games || 0,
                Blitz: data.perfs.blitz.games || 0,
                Rapid: data.perfs.rapid.games || 0,
                Classical: data.perfs.classical.games || 0,
                Correspondence: data.perfs.correspondence ? data.perfs.correspondence.games : 0
            };

            const yearsData = calculateGamesPerYear(games);
            const winLossData = calculateWinLoss(games);
            const colorPerformance = calculateColorPerformance(games);

            console.log("Color Performance Data:", colorPerformance); // Log the data to debug

            renderTimeControlChart(timeControls);
            renderGamesPerYearChart(yearsData);
            renderWinLossChart(winLossData);
            renderColorPerformanceChart(colorPerformance);
        }

        function calculateGamesPerYear(games) {
            const yearCounts = {};
            games.forEach(game => {
                const date = new Date(game.date);
                const year = date.getFullYear();
                if (!yearCounts[year]) {
                    yearCounts[year] = 0;
                }
                yearCounts[year]++;
            });
            console.log("Games Per Year Data:", yearCounts); // Debugging log
            return yearCounts;
        }

        function calculateWinLoss(games) {
            const results = { Win: 0, Loss: 0, Draw: 0 };
            games.forEach(game => {
                if (game.result === "1-0") results.Win++;
                else if (game.result === "0-1") results.Loss++;
                else if (game.result === "1/2-1/2") results.Draw++;
            });

            // Calculate percentages
            const totalGames = results.Win + results.Loss + results.Draw;
            if (totalGames > 0) {
                results.WinPercentage = (results.Win / totalGames) * 100;
                results.LossPercentage = (results.Loss / totalGames) * 100;
                results.DrawPercentage = (results.Draw / totalGames) * 100;
            } else {
                results.WinPercentage = results.LossPercentage = results.DrawPercentage = 0;
            }

            console.log("Win/Loss Data:", results); // Debugging log
            return results;
        }

        function calculateColorPerformance(games) {
            const colors = { White: 0, Black: 0 };
            games.forEach(game => {
                colors[game.color]++;
            });
            console.log("Calculated Color Performance:", colors); // Debugging log
            return colors;
        }

        function renderTimeControlChart(data) {
            const ctx = document.getElementById('timeControlChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'Games Played by Time Control',
                        data: Object.values(data),
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                    }]
                },
                options: { responsive: true }
            });
        }

        function renderGamesPerYearChart(data) {
            const ctx = document.getElementById('gamesPerYearChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'Games Played Per Year',
                        data: Object.values(data),
                        backgroundColor: '#36A2EB',
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderWinLossChart(data) {
            const ctx = document.getElementById('winLossChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Wins', 'Losses', 'Draws'],
                    datasets: [{
                        label: 'Win/Loss/Draw Distribution',
                        data: [data.WinPercentage, data.LossPercentage, data.DrawPercentage],
                        backgroundColor: ['#4BC0C0', '#FF6384', '#FFCE56'],
                    }]
                },
                options: { responsive: true }
            });
        }

        function renderColorPerformanceChart(data) {
            const ctx = document.getElementById('colorPerformanceChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['White', 'Black'],
                    datasets: [{
                        label: 'Performance by Color',
                        data: [data.White, data.Black],
                        backgroundColor: ['#36A2EB', '#9966FF'],
                    }]
                },
                options: { responsive: true }
            });
        }
    </script>
</body>

</html>
