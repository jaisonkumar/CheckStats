<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 900px;
            margin: auto;
            padding: 20px;
        }

        h1, h3 {
            text-align: center;
            margin-bottom: 20px;
        }

        .stats-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 20px;
        }

        .chart-container {
            margin-top: 30px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Player Analysis</h1>
        <div id="playerStats" class="stats-card"></div>

        <!-- Graph Containers -->
        <div class="chart-container">
            <h3>Time Controls Distribution</h3>
            <canvas id="timeControlChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Game Results Over Time (Win/Loss/Draw)</h3>
            <canvas id="gameResultsOverTimeChart"></canvas>
        </div>
    </div>

    <script>
        // Extract the username from the query parameters
        const params = new URLSearchParams(window.location.search);
        const username = params.get('username');

        if (!username) {
            alert("No username provided. Redirecting to the homepage.");
            window.location.href = "/";
        } else {
            fetch(`https://lichess.org/api/user/${username}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("User not found.");
                    }
                    return response.json();
                })
                .then(data => {
                    fetch(`https://lichess.org/api/games/user/${username}?max=200&opening=false`) // Fetch a limited number of games
                        .then(gamesResponse => gamesResponse.text())
                        .then(gamesData => {
                            const games = parseGames(gamesData);
                            displayAnalysis(data, games);
                        });
                })
                .catch(error => {
                    alert(error.message);
                    window.location.href = "/";
                });
        }

        function parseGames(gamesData) {
            const lines = gamesData.split("\n");
            const games = [];

            for (let i = 0; i < lines.length; i++) {
                if (lines[i].startsWith("[Event")) {
                    const timeControl = lines[i + 1].match(/"([^"]+)"/)[1]; // Extract Time Control
                    const date = lines[i + 4].match(/"([^"]+)"/)[1]; // Extract Date
                    const result = lines[i + 6].match(/"([^"]+)"/)[1]; // Extract Result
                    const color = lines[i + 7].includes("White") ? "White" : "Black";
                    games.push({ timeControl, date, result, color });
                }
            }
            return games;
        }

        function displayAnalysis(data, games) {
            const statsDiv = document.getElementById('playerStats');
            statsDiv.innerHTML = ` 
                <h3>${data.username}</h3>
                <p><strong>Total Games:</strong> ${data.count.all}</p>
                <p><strong>Wins:</strong> ${data.count.win || 0}</p>
                <p><strong>Losses:</strong> ${data.count.loss || 0}</p>
                <p><strong>Draws:</strong> ${data.count.draw || 0}</p>
                <p><strong>Time Controls:</strong> Bullet: ${data.perfs.bullet.games || 0}, Blitz: ${data.perfs.blitz.games || 0}, 
                Rapid: ${data.perfs.rapid.games || 0}, Classical: ${data.perfs.classical.games || 0}</p>
            `;

            const timeControls = {
                Bullet: data.perfs.bullet.games || 0,
                Blitz: data.perfs.blitz.games || 0,
                Rapid: data.perfs.rapid.games || 0,
                Classical: data.perfs.classical.games || 0,
                Correspondence: data.perfs.correspondence ? data.perfs.correspondence.games : 0
            };

            const gameResultsOverTime = calculateGameResultsOverTime(games);

            renderTimeControlChart(timeControls);
            renderGameResultsOverTimeChart(gameResultsOverTime);
        }

        function calculateGameResultsOverTime(games) {
            const resultsOverTime = {};
            games.forEach(game => {
                const date = new Date(game.date);
                const year = date.getFullYear();
                const month = date.getMonth() + 1; // Get the month (1-12)
                const yearMonth = `${year}-${month < 10 ? '0' + month : month}`;

                if (!resultsOverTime[yearMonth]) {
                    resultsOverTime[yearMonth] = { Win: 0, Loss: 0, Draw: 0 };
                }

                if (game.result === "1-0") resultsOverTime[yearMonth].Win++;
                else if (game.result === "0-1") resultsOverTime[yearMonth].Loss++;
                else if (game.result === "1/2-1/2") resultsOverTime[yearMonth].Draw++;
            });

            return resultsOverTime;
        }

        function renderTimeControlChart(data) {
            const ctx = document.getElementById('timeControlChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'Games Played by Time Control',
                        data: Object.values(data),
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                    }]
                },
                options: { responsive: true }
            });
        }

        function renderGameResultsOverTimeChart(data) {
            const months = Object.keys(data);
            const wins = months.map(month => data[month].Win);
            const losses = months.map(month => data[month].Loss);
            const draws = months.map(month => data[month].Draw);

            const ctx = document.getElementById('gameResultsOverTimeChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Wins',
                            data: wins,
                            borderColor: '#36A2EB',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Losses',
                            data: losses,
                            borderColor: '#FF6384',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Draws',
                            data: draws,
                            borderColor: '#FFCE56',
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'category',
                            title: { display: true, text: 'Month-Year' }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Games' }
                        }
                    }
                }
            });
        }
    </script>
</body>

</html>
